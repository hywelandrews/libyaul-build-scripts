# -*- mode: shell-script -*-

# Copyright (c) 2012-2016
# See LICENSE for details.
#
# Dave Murphy <davem@devkitpro.org>
# Israel Jacquez <mrkotfw@gmail.com>
# Joe Fenton <jlfenton65@gmail.com>

[[ "${BASH_SOURCE[0]}" != "${0}" ]]  || exit 1

is_var_set "target"

# Build and install Binutils
mkdir -p "${BUILD_SRC_DIR}/${target}/binutils"
cd "${BUILD_SRC_DIR}/${target}/binutils"
if [ ! -f "${BUILD_STAMPS_DIR}/${target}-configured-binutils" ]; then
    message "Configuring Binutils"
    CFLAGS="-Wno-error=unused-value -Wno-error=shift-negative-value" LDFLAGS="" ../"${BINUTILS_SRC_DIR}"/configure \
        --prefix="${BUILD_INSTALL_DIR}/${target}" \
        --target="${target}" \
        --disable-error \
        --disable-debug \
        --disable-nls \
        --disable-shared \
        --disable-threads \
        --with-gcc \
        --with-gnu-as \
        --with-gnu-ld \
        --with-stabs 1>> "${BUILD_SRC_DIR}/binutils-${target}.log" 2>&1 \
        || panic "See '${BUILD_SRC_DIR}/binutils-${target}.log'" 1
    touch "${BUILD_STAMPS_DIR}/${target}-configured-binutils"
fi

if [ ! -f "${BUILD_STAMPS_DIR}/${target}-built-binutils" ]; then
    message "Building Binutils"
    "${MAKE}" 1>> "${BUILD_SRC_DIR}/binutils-${target}.log" 2>&1 || \
        panic "See '${BUILD_SRC_DIR}/binutils-${target}.log'" 1
    touch "${BUILD_STAMPS_DIR}/${target}-built-binutils"
fi

if [ ! -f "${BUILD_STAMPS_DIR}/${target}-installed-binutils" ]; then
    message "Installing Binutils"
    "${MAKE}" install 1>> "${BUILD_SRC_DIR}/binutils-${target}.log" 2>&1 || \
        panic "See '${BUILD_SRC_DIR}/binutils-${target}.log'" 1
    touch "${BUILD_STAMPS_DIR}/${target}-installed-binutils"
fi
touch "${BUILD_STAMPS_DIR}/${target}-completed-binutils"
cd "${OLDPWD}"
